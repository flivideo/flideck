# CLAUDE.md - FliDeck

## Project Overview

FliDeck is a **local-first presentation harness** that discovers, mounts, and displays folder-based HTML artifacts generated by Claude Code agents.

**Purpose:** Viewing and navigating generated visual assets without manual file management or browser tab chaos.

**What it is NOT:** A presentation builder, editor, or templating engine. FliDeck supports minimal editing capabilities (e.g., asset ordering via drag-and-drop) but is primarily a viewer.

## Quick Start

```bash
# Install dependencies
npm install

# Start development (both client and server)
npm run dev

# Build for production
npm run build

# Run production server
npm start
```

## Architecture

**Monorepo Structure:**
- `client/` - React 19 + Vite + TailwindCSS (port 5200)
- `server/` - Express 5 + Socket.io + Chokidar (port 5201)
- `shared/` - TypeScript types shared between client/server

## Key Patterns

### Backend Patterns
- **WatcherManager** - Centralized file watching with debouncing
- **PresentationService** - Singleton EventEmitter for discovery/caching
- **Route Factory** - Dependency injection for routes
- **AppError + asyncHandler** - Clean async error handling

### Frontend Patterns
- **TanStack Query** - Server state with Socket.io invalidation
- **Socket.io Hooks** - Connection status, room management
- **React Router** - URL-based navigation

## API Endpoints

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/presentations` | List all presentations |
| GET | `/api/presentations/:id` | Get single presentation |
| POST | `/api/presentations/refresh` | Force refresh cache |
| PUT | `/api/presentations/:id/order` | Update asset order |
| GET | `/api/assets/:presentationId/:assetId` | Get asset content |
| GET | `/api/health` | Health check |

## Socket.io Events

| Event | Direction | Description |
|-------|-----------|-------------|
| `presentations:updated` | Server -> Client | File system changed |
| `config:changed` | Server -> Client | Config reloaded (hot reload) |
| `join:presentation` | Client -> Server | Join presentation room |
| `leave:presentation` | Client -> Server | Leave presentation room |

## Keyboard Shortcuts

| Key | Action |
|-----|--------|
| `Cmd/Ctrl + K` | Open quick filter (search presentations/assets) |
| `F` | Toggle presentation mode (hide chrome) |
| `Escape` | Exit presentation mode / close quick filter |
| `Cmd/Ctrl + ←` | Previous asset |
| `Cmd/Ctrl + →` | Next asset |
| `Cmd/Ctrl + Home` | First asset |
| `Cmd/Ctrl + End` | Last asset |
| `Alt/Option + hover` | Reveal copy path buttons (URL, ABS, REL) |

**Note:** Modifier keys (`Cmd` on Mac, `Ctrl` on Windows/Linux) are required for navigation to avoid conflicts with presentation's internal controls.

**Copy Path:** Hold `Alt` (Option on Mac) and hover over an asset row or the "Assets" header to reveal copy buttons for URL, absolute path, or relative path.

## File Discovery Rules

1. FliDeck watches `presentationsRoot` from config.json
2. Any subfolder containing `index.html` is a valid presentation
3. All `.html` files in the folder are considered assets
4. Asset order: Uses `index.json` manifest if present, otherwise default (index first, then by creation time)

## Asset Ordering

Assets can be reordered via drag-and-drop in the sidebar. The order is persisted in an `index.json` manifest file within each presentation folder.

**Backwards Compatibility:** FliDeck also reads legacy `flideck.json` files if `index.json` doesn't exist. New saves always go to `index.json`.

**Manifest Structure:**
```json
{
  "assets": {
    "order": ["intro.html", "main.html", "conclusion.html", "index.html"]
  }
}
```

**Self-healing behavior:**
- Missing files in manifest are silently skipped
- New files not in manifest appear at end (alphabetically)
- Invalid/corrupted manifest falls back to default ordering

## Configuration

FliDeck uses a JSON configuration file for dynamic settings.

**Files:**
- `config.json` - User config (gitignored)
- `config.example.json` - Template with defaults

**Config Structure:**
```json
{
  "presentationsRoot": "~/path/to/presentations",
  "history": ["~/previous/path"]
}
```

**Features:**
- Tilde (`~`) paths expanded to home directory
- Hot reload - changes apply without restart
- History tracks previously used roots (max 10)
- Falls back to `config.example.json` if `config.json` missing

**To configure:** Copy `config.example.json` to `config.json` and edit.

## Environment Variables

| Variable | Default | Description |
|----------|---------|-------------|
| `PORT` | 5201 | Server port |
| `CLIENT_URL` | http://localhost:5200 | CORS origin |
| `NODE_ENV` | development | Environment mode |

## Common Tasks

### Adding a new API endpoint

1. Create route handler in `server/src/routes/`
2. Use `asyncHandler` for async routes
3. Register in `server/src/routes/index.ts`

### Adding a new UI component

1. Create component in `client/src/components/`
2. Use TailwindCSS for styling
3. Import and use in pages

### Adding a new Socket.io event

1. Define event type in `shared/src/types.ts`
2. Emit from server in appropriate location
3. Handle in client using `useSocketInvalidation` hook

## Success Criteria (v0.1.0)

1. App discovers presentations from configured root folder
2. App displays list of available presentations
3. User can select a presentation and see its assets
4. User can switch between assets
5. Assets render correctly with their own styles
6. File changes trigger UI refresh
7. Basic navigation (back, forward, home) works

## Git Hooks

### Pre-commit: Gitleaks

A pre-commit hook using [gitleaks](https://github.com/gitleaks/gitleaks) prevents committing secrets (API keys, passwords, tokens).

**If secrets are detected:**
1. Remove the secret from your code
2. Use environment variables instead (add to `.env`, reference via `process.env`)
3. For false positives, add to `.gitleaksignore`

**To bypass (not recommended):**
```bash
git commit --no-verify
```

## Related Documentation

- `docs/planning/requirements.md` - Full requirements specification
- `docs/planning/architecture.md` - Detailed architecture decisions
