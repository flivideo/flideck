# FR-27: Agent Capability Discovery API

## Summary

Provide a self-describing API endpoint that agents can query to discover FliDeck's capabilities, concepts, and workflows in human-readable format. This enables agents to stay current with FliDeck's features without embedded documentation.

## Problem Statement

**Current state:**
- Agents need embedded knowledge about FliDeck's API
- When FliDeck adds features, all agents need updating
- Claude's plugin system makes agent updates difficult
- No discovery mechanism - agents must "just know" what's available

**Impact:**
- Agent integration is brittle
- New features aren't automatically discoverable
- Each agent duplicates FliDeck knowledge
- DAM skill pattern (discovery-based) can't be applied

**Desired state:**
- Agent asks "What can you do?"
- FliDeck responds with capabilities in natural language
- Agent adapts to available features dynamically

## Proposed Solution

### New Endpoint: Capabilities Discovery

```
GET /api/capabilities
```

Returns human-readable, agent-friendly description of FliDeck.

### Response Structure

```json
{
  "name": "FliDeck Presentation Server",
  "version": "0.2.0",
  "description": "A local-first presentation viewer that discovers, organizes, and displays HTML slides generated by AI agents.",

  "concepts": {
    "presentation": {
      "summary": "A folder containing HTML slides and an index.json manifest",
      "details": "Each presentation is a directory under the configured presentationsRoot. FliDeck discovers presentations automatically by looking for folders containing HTML files."
    },
    "tab": {
      "summary": "A perspective or persona view within a presentation",
      "details": "Tabs allow one presentation to have multiple entry points. Each tab has its own index HTML file (e.g., index-mary.html). When a user clicks a tab, they see that tab's index and the sidebar filters to show only slides belonging to that tab.",
      "when_to_use": "Use tabs when a presentation has content for different audiences (e.g., personas like Mary, John) or different aspects (e.g., Overview, Deep Dive)."
    },
    "group": {
      "summary": "A collection of related slides shown as a collapsible section",
      "details": "Groups organize slides in the sidebar. A group can optionally belong to a tab via the tabId property. Groups without tabId appear in all tabs.",
      "when_to_use": "Use groups when you have 15+ slides that benefit from organization."
    },
    "slide": {
      "summary": "An individual HTML file displayed in the viewer",
      "details": "Slides are the core content. They can be standalone or assigned to groups. FliDeck discovers slides from the filesystem but prefers metadata from the manifest."
    },
    "manifest": {
      "summary": "The index.json file that defines presentation structure",
      "details": "The manifest is the source of truth for tabs, groups, slide metadata, and ordering. FliDeck APIs update the manifest. Changes trigger real-time UI updates via WebSocket."
    }
  },

  "common_workflows": {
    "add_slide_to_presentation": {
      "description": "Add a new slide to an existing presentation",
      "steps": [
        "1. Write your HTML slide file to the presentation folder",
        "2. Call POST /api/presentations/{id}/slides with { file: 'yourslide.html', group?: 'group-id', title?: 'Display Name' }",
        "3. FliDeck updates the manifest and notifies connected clients"
      ],
      "example": {
        "method": "POST",
        "url": "/api/presentations/my-deck/slides",
        "body": { "file": "new-feature.html", "group": "features", "title": "New Feature Overview" }
      }
    },
    "create_tabbed_presentation": {
      "description": "Create a presentation with multiple perspectives/personas",
      "steps": [
        "1. Create the presentation folder with slides",
        "2. Create index-{tabId}.html files for each tab (e.g., index-mary.html)",
        "3. Call POST /api/presentations/{id}/tabs for each tab",
        "4. Create groups with tabId assignments",
        "5. Assign slides to groups"
      ],
      "example": {
        "method": "POST",
        "url": "/api/presentations/my-deck/tabs",
        "body": { "id": "mary", "label": "Mary's View" }
      }
    },
    "sync_manifest_with_filesystem": {
      "description": "Auto-discover slides and update manifest",
      "steps": [
        "1. Call PUT /api/presentations/{id}/manifest/sync with options",
        "2. FliDeck scans filesystem for HTML files",
        "3. Manifest is updated with discovered slides"
      ],
      "example": {
        "method": "PUT",
        "url": "/api/presentations/my-deck/manifest/sync",
        "body": { "strategy": "merge", "inferGroups": true, "inferTitles": true }
      }
    },
    "query_current_state": {
      "description": "Get the current state of a presentation",
      "steps": [
        "1. Call GET /api/presentations/{id}",
        "2. Response includes tabs, groups, slides, and metadata"
      ],
      "example": {
        "method": "GET",
        "url": "/api/presentations/my-deck"
      }
    }
  },

  "api_summary": {
    "health": {
      "GET /api/health": "Check if FliDeck is running"
    },
    "presentations": {
      "GET /api/presentations": "List all presentations",
      "GET /api/presentations/:id": "Get single presentation with full data",
      "POST /api/presentations": "Create new presentation"
    },
    "manifest": {
      "GET /api/presentations/:id/manifest": "Get raw manifest JSON",
      "PUT /api/presentations/:id/manifest": "Replace entire manifest",
      "PATCH /api/presentations/:id/manifest": "Partial manifest update"
    },
    "slides": {
      "POST /api/presentations/:id/slides": "Add slide to manifest",
      "PUT /api/presentations/:id/slides/:slideId": "Update slide metadata",
      "DELETE /api/presentations/:id/slides/:slideId": "Remove slide from manifest"
    },
    "tabs": {
      "POST /api/presentations/:id/tabs": "Create tab",
      "PUT /api/presentations/:id/tabs/:tabId": "Rename tab",
      "DELETE /api/presentations/:id/tabs/:tabId": "Delete tab",
      "PUT /api/presentations/:id/tabs/order": "Reorder tabs"
    },
    "groups": {
      "POST /api/presentations/:id/groups": "Create group",
      "PUT /api/presentations/:id/groups/:groupId": "Rename group",
      "DELETE /api/presentations/:id/groups/:groupId": "Delete group",
      "PUT /api/presentations/:id/groups/:groupId/parent": "Assign group to tab",
      "DELETE /api/presentations/:id/groups/:groupId/parent": "Remove group from tab"
    },
    "bulk_operations": {
      "POST /api/presentations/:id/manifest/slides/bulk": "Add multiple slides",
      "PUT /api/presentations/:id/manifest/sync": "Sync manifest with filesystem",
      "POST /api/presentations/:id/manifest/validate": "Validate manifest"
    },
    "schema": {
      "GET /api/schema/manifest": "Get JSON Schema for manifest validation"
    }
  },

  "tips": [
    "Always check GET /api/health first to confirm FliDeck is running",
    "Use GET /api/presentations/:id to understand current state before making changes",
    "Prefer API calls over direct file writes - FliDeck validates and broadcasts changes",
    "If FliDeck is offline, you can write index.json directly as fallback",
    "Tab-specific slides need: tab → group with tabId → slide in group",
    "Slides without groups appear in ALL tabs (root assets)"
  ],

  "documentation": {
    "knowledge_base": "docs/architecture/flideck-knowledge-base.md",
    "api_reference": "CLAUDE.md",
    "schema": "/api/schema/manifest"
  }
}
```

## Acceptance Criteria

- [ ] `GET /api/capabilities` returns structured capability description
- [ ] Response includes all concepts (presentation, tab, group, slide, manifest)
- [ ] Response includes common workflows with examples
- [ ] Response includes API summary organized by category
- [ ] Response includes practical tips for agents
- [ ] Response is human-readable (not just JSON Schema)
- [ ] Response includes version number for compatibility checking
- [ ] Response updates automatically when new features are added

## Technical Notes

### Implementation

Simple static response (can be generated from code comments/docs):

```typescript
// server/src/routes/capabilities.ts
import { Router } from 'express';

const router = Router();

router.get('/', (_req, res) => {
  res.json({
    name: 'FliDeck Presentation Server',
    version: process.env.npm_package_version || '0.2.0',
    // ... rest of capabilities object
  });
});

export default router;
```

### Maintenance

Keep capabilities in sync with actual features:
1. Define capabilities as TypeScript const
2. Reference from route handler
3. Update when adding features
4. Consider generating from code annotations (future)

### Agent Usage Pattern

```typescript
// Agent workflow
async function discoverFliDeck() {
  const health = await fetch('http://localhost:5201/api/health');
  if (!health.ok) {
    console.log('FliDeck not running, using direct file access');
    return null;
  }

  const capabilities = await fetch('http://localhost:5201/api/capabilities');
  const caps = await capabilities.json();

  console.log(`Connected to ${caps.name} v${caps.version}`);
  console.log('Available workflows:', Object.keys(caps.common_workflows));

  return caps;
}
```

## Dependencies

None - standalone feature.

## Related

- `docs/architecture/flideck-knowledge-base.md` - Full documentation
- DAM skill pattern - Similar discovery approach

## Priority

**Medium** - Enables sustainable agent integration without constant updates.

---

**Added**: 2025-12-26
**Status**: Implemented

---

## Completion Notes

**What was done:**
- Created `GET /api/capabilities` endpoint returning structured capability description
- Response includes all concepts (presentation, tab, group, slide, manifest)
- Response includes common workflows with examples (add_slide, create_tabbed, sync, query, sync-from-index)
- Response includes API summary organized by category (health, capabilities, presentations, manifest, slides, tabs, groups, bulk_operations, schema, templates)
- Response includes practical tips for agents
- Human-readable descriptions, not just JSON Schema
- Version number included for compatibility checking
- Added sync-from-index workflow (FR-26) to capabilities

**Files created:**
- `server/src/routes/capabilities.ts` - Route handler with CAPABILITIES object

**Files modified:**
- `server/src/routes/index.ts` - Registered capabilities route
- `CLAUDE.md` - Added endpoint to API table

**Testing notes:**
```bash
curl http://localhost:5201/api/capabilities | jq
```

**Status:** Complete
